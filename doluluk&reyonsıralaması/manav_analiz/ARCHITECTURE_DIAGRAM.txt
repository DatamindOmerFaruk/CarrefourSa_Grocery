╔══════════════════════════════════════════════════════════════════════════════════════════════════╗
║                    MANAV ANALİZ SİSTEMİ - MİMARİ DİYAGRAMI                                         ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────────────────────────────┐
│                             1. GÖRÜNTÜ KAYNAĞI KATMANI                                           │
└──────────────────────────────────────────────────────────────────────────────────────────────────┘

           ┌──────────────────┐
           │  Kamera Sistemi   │
           │ multi_camera_     │
           │     system        │
           └────────┬──────────┘
                    │
                    │ PTZ Snapshot
                    │ (JPEG Images)
                    │
                    ▼
    ┌──────────────────────────────────────┐
    │     Azure Blob Storage               │
    │  Container: snapshot                 │
    │  📦 Görüntü Depolama                 │
    └──────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────────┐
│                             2. BATCH İŞLEME KATMANI                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────────┘

                    │
                    │ 1. List Blobs
                    │ 2. SAS URL Oluştur
                    ▼
    ┌──────────────────────────────────────┐
    │     Batch Processor                  │
    │  batch_processor.py                  │
    │  ⚙️ Toplu İşleme                     │
    │                                      │
    │  • Mod 1: Tam Analiz                │
    │  • Mod 2: Sadece Stock               │
    │  • Batch Size: 10                    │
    │  • Retry: 3                          │
    └───────────┬──────────────────────────┘
                │
                │ 3. API Çağrıları
                │    (SAS URL ile)
                │
                ▼

┌──────────────────────────────────────────────────────────────────────────────────────────────────┐
│                             3. API SERVİSİ KATMANI                                               │
└──────────────────────────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────────────────────────────────────┐
    │                    FastAPI Service                                  │
    │                  main.py:8000                                         │
    │                  🌐 REST API                                         │
    └──────────────────────────────────────────────────────────────────────┘
                                │
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
    ┌─────────┐          ┌─────────┐          ┌─────────┐
    │ /analyze│          │ /analyze│          │ /analyze│
    │/content │          │ /stock  │          │/evalu-  │
    │         │          │         │          │  ation  │
    │📋 İçerik│          │📊 Stok  │          │🏥 Yerle-│
    │ Analizi │          │ Analizi │          │  şim    │
    └────┬────┘          └────┬────┘          └────┬────┘
         │                    │                    │
         └────────────┬───────┴────────────────────┘
                      │
                      ▼
    ┌──────────────────────────────────────┐
    │      Görüntü İşleme Pipeline         │
    │                                      │
    │  1. PIL Enhancement:                │
    │     • Kontrast ↑ 15%                │
    │     • Netlik ↑ 10%                  │
    │     • Renk Doygunluğu ↑ 5%          │
    │                                      │
    │  2. Resize: Max 2560x1920           │
    │                                      │
    │  3. Base64 Encoding                  │
    │     (JPEG Quality: 98%)              │
    └──────────────┬───────────────────────┘
                   │
                   │ Base64 Image
                   │ + Prompt
                   │
                   ▼

┌──────────────────────────────────────────────────────────────────────────────────────────────────┐
│                             4. AI ANALİZ KATMANI                                                 │
└──────────────────────────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────┐
    │   Prompt Şablonları                  │
    │                                      │
    │  • CONTENT_PROMPT                    │
    │    → Meyve/sebze tanıma              │
    │                                      │
    │  • STOCK_PROMPT                      │
    │    → Doluluk analizi                 │
    │                                      │
    │  • EVALUATION_PROMPT                 │
    │    → Etilen kuralları                │
    │                                      │
    └──────────────┬───────────────────────┘
                   │
                   ▼
    ┌──────────────────────────────────────┐
    │   Azure OpenAI                        │
    │   GPT-4.1 Vision                      │
    │   🤖 LLM Analiz Servisi               │
    │                                      │
    │  Parameters:                         │
    │  • Max Tokens: 1500                  │
    │  • Temperature: 0.2                   │
    │  • Top-P: 0.9                        │
    └──────────────┬───────────────────────┘
                   │
                   │ JSON Response
                   │
                   ▼

┌──────────────────────────────────────────────────────────────────────────────────────────────────┐
│                             5. VERİTABANI KATMANI                                                │
└──────────────────────────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────┐
    │     PostgreSQL Database              │
    │     🗄️ Sonuç Depolama               │
    └──────────────────────────────────────┘
                   │
        ┌──────────┼──────────┐
        │          │          │
        ▼          ▼          ▼
    ┌─────────┐ ┌─────────┐ ┌─────────┐
    │analyze_ │ │analyze_ │ │analyze_ │
    │  _row   │ │  stock  │ │evalu-   │
    │         │ │  _row   │ │  ation  │
    │📋 İçerik│ │📊 Stok  │ │🏥 Yerle-│
    │ Analizi │ │ Durumu  │ │  şim    │
    └─────────┘ └─────────┘ └─────────┘

═══════════════════════════════════════════════════════════════════════════════════════════════════

                    VERİ AKIŞI (SEQUENCE DIAGRAM)

┌─────────┐  ┌──────────┐  ┌────────┐  ┌───────┐  ┌──────────┐  ┌───────┐
│ Kamera  │  │  Azure  │  │ Batch  │  │ Fast  │  │ Azure    │  │ Post- │
│ Sistemi │  │ Storage │  │Process │  │  API  │  │  OpenAI  │  │ greSQL│
└────┬────┘  └────┬─────┘  └───┬────┘  └───┬───┘  └─────┬─────┘  └───┬───┘
     │           │             │          │           │           │
     │ Snapshot  │             │          │           │           │
     │──────────>│             │          │           │           │
     │           │             │          │           │           │
     │           │ List Blobs  │          │           │           │
     │           │<────────────│          │           │           │
     │           │────────────>│          │           │           │
     │           │             │          │           │           │
     │           │             │ POST     │           │           │
     │           │             │/content  │           │           │
     │           │             │─────────>│           │           │
     │           │             │          │ Enhance   │           │
     │           │             │          │ Image     │           │
     │           │             │          │──────────>│           │
     │           │             │          │           │ Vision    │
     │           │             │          │           │ API       │
     │           │             │          │           │──────────>│
     │           │             │          │           │<──────────│
     │           │             │          │<──────────│           │
     │           │             │<─────────│           │           │
     │           │             │          │           │           │
     │           │             │ POST     │           │           │
     │           │             │/stock    │           │           │
     │           │             │─────────>│           │           │
     │           │             │          │ Vision    │           │
     │           │             │          │ API       │           │
     │           │             │          │──────────>│           │
     │           │             │          │<──────────│           │
     │           │             │<─────────│           │           │
     │           │             │          │           │           │
     │           │             │ POST     │           │           │
     │           │             │/evaluation           │           │
     │           │             │─────────>│           │           │
     │           │             │          │ Vision    │           │
     │           │             │          │ API       │           │
     │           │             │          │──────────>│           │
     │           │             │          │<──────────│           │
     │           │             │<─────────│           │           │
     │           │             │          │           │           │
     │           │             │ INSERT   │           │           │
     │           │             │─────────────────────────────────>│
     │           │             │ INSERT   │           │           │
     │           │             │─────────────────────────────────>│
     │           │             │ INSERT   │           │           │
     │           │             │─────────────────────────────────>│

═══════════════════════════════════════════════════════════════════════════════════════════════════

                              SİSTEM ÖZELLİKLERİ

┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                           TEKNOLOJİ STACK                                                     │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  Backend:           Python 3.x, FastAPI, Uvicorn                                            │
│  Cloud Services:    Azure Blob Storage, Azure OpenAI GPT-4.1                                │
│  Database:         PostgreSQL, Psycopg2                                                     │
│  Image Processing: Pillow (PIL)                                                             │
│  Utilities:        Python-dotenv, Requests, Logging                                         │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                           PERFORMANS ÖZELLİKLERİ                                              │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  ✓ Batch İşleme:     Toplu görsel işleme (default: 10 görsel/batch)                        │
│  ✓ Retry Mekanizması: 3 deneme                                                             │
│  ✓ Request Throttling: İstekler arası gecikme (1s)                                         │
│  ✓ Progress Tracking: İlerleme takibi ve detaylı loglama                                   │
│  ✓ Error Handling:   Kapsamlı hata yönetimi                                                │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════════════════════════

                              KULLANIM SENARYOLARI

┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│  SENARYO 1: TAM ANALİZ                                                                      │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  Batch Processor → Content API → Stock API → Evaluation API → PostgreSQL                   │
│                                                                                             │
│  ✓ 3 farklı analiz tipi                                                                     │
│  ✓ Detaylı sonuçlar                                                                         │
│  ⏱ Yaklaşık 3x API çağrısı süresi                                                         │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│  SENARYO 2: HIZLI STOCK KONTROLÜ                                                            │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  Batch Processor → Stock API → PostgreSQL                                                  │
│                                                                                             │
│  ✓ Sadece stok durumu                                                                      │
│  ✓ Hızlı işleme                                                                            │
│  ⏱ Tek API çağrısı süresi                                                                  │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│  SENARYO 3: MANUEL API ÇAĞRISI                                                             │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  Client → FastAPI → Azure OpenAI → JSON Response                                           │
│                                                                                             │
│  ✓ Tek görsel analizi                                                                      │
│  ✓ REST API endpoint'leri                                                                  │
│  ✓ Swagger UI: http://localhost:8000/docs                                                  │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════════════════════════

